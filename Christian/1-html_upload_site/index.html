<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdn.tailwindcss.com"></script>
        <title>Image View and Upload</title>
    </head>

    <body class="flex flex-col gap-2 p-2">
        <div class="border border-black rounded p-2">
            <h3>Upload</h3>
            <input class="" type="file" id="fileInput" multiple />
            <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-2 rounded inline-flex items-center" id="uploadButton">
                Hochladen
            </button>
            <p id="status"></p>
        </div>
        <div class="border border-black rounded p-2">
            <h3>View</h3>
            <div id="images" class="flex flex-wrap gap-2"></div>
        </div>
        <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center">
            <img id="modal-image" src="" alt="Großes Bild" class="max-w-full max-h-full" />
            <button id="close-modal" class="absolute top-4 right-4 text-white text-2xl">×</button>
        </div>
        <script>
            const storageUrl = "###URL###/images/upload";
            const listUrl200 = "###URL###/images";
            const listUrl800 = "###URL###/images";
            const listUrl1024 = "###URL###/images";
            const sasToken = "###SAS###";

            let update = false;
            let blobList = [];
            let imageList = [];

            async function getBlops() {
                const response = await fetch(`${listUrl200}?${sasToken}&restype=container&comp=list`);
                const data = await response.text();

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data, "application/xml");
                const blobs = xmlDoc.getElementsByTagName("Blob");
                for (const blob of blobs) {
                    const blobName = blob.getElementsByTagName("Name")[0].textContent;
                    if (!blobName.includes("images-resize-200/")) continue;
                    if (!blobList.includes(blobName)) blobList.push(blobName);
                }
                await checkForNewBlobs();
            }
            async function checkForNewBlobs() {
                blobList.forEach(async (blobName) => {
                    if (!imageList.includes(blobName)) {
                        imageList.push(blobName);
                        await addImageToContainer(blobName);
                    }
                });
            }
            async function addImageToContainer(blobName) {
                const imagesContainer = document.getElementById("images");
                const img = document.createElement("img");
                img.alt = blobName;
                img.src = `${listUrl200}/${blobName}?${sasToken}`;
                img.data;
                img.setAttribute("data-large-src", `${listUrl1024}/${blobName.replace("images-resize-200/", "images-resize-1024/")}?${sasToken}`);
                img.addEventListener("click", () => {
                    const modalImage = document.getElementById("modal-image");
                    modalImage.src = img.getAttribute("data-large-src");

                    const modal = document.getElementById("image-modal");
                    modal.classList.remove("hidden");
                });
                imagesContainer.appendChild(img);
                update = false;
            }

            getBlops();
            document.getElementById("image-modal").addEventListener("click", () => {
                const modal = document.getElementById("image-modal");
                modal.classList.add("hidden");
            });
            const spinnerChars = ["|", "/", "-", "\\"];
            let spinnerIndex = 0;
            let spinnerInterval = null;

            function startSpinner() {
                const statusEl = document.getElementById("status");
                spinnerInterval = setInterval(() => {
                    spinnerIndex = (spinnerIndex + 1) % spinnerChars.length;
                    // Der eigentliche Status-Text wird außerhalb aktualisiert,
                    // hier aktualisieren wir nur den Spinner.
                    const currentText = statusEl.textContent;
                    // Wir suchen den letzten Index des Spinners im Text und ersetzen ihn.
                    // Wenn Sie den Spinner separat halten wollen, trennen Sie bitte Status und Spinner-Anzeige.
                    // Hier vereinfachen wir: Der gesamte Text wird jedes Mal neu gesetzt.
                    if (currentText.includes("...")) {
                        const parts = currentText.split("...");
                        statusEl.textContent = parts[0] + "... " + spinnerChars[spinnerIndex];
                    } else {
                        // Falls kein ... gefunden wird, fügen wir es hinzu.
                        statusEl.textContent = currentText + " ... " + spinnerChars[spinnerIndex];
                    }
                }, 200);
            }

            function stopSpinner() {
                if (spinnerInterval) {
                    clearInterval(spinnerInterval);
                    spinnerInterval = null;
                    spinnerIndex = 0;
                }
            }

            document.getElementById("uploadButton").addEventListener("click", async () => {
                const fileInput = document.getElementById("fileInput");
                const files = fileInput.files;

                if (!files || files.length === 0) {
                    alert("Bitte wählen Sie mindestens eine Datei aus.");
                    return;
                }

                document.getElementById("status").textContent = `Starte Upload von ${files.length} Datei(en)`;
                startSpinner();

                let allOk = true;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    document.getElementById("status").textContent = `Lade Datei ${i + 1} von ${files.length} hoch...`;

                    const timestamp = Date.now();
                    const blobUrl = `${storageUrl}/${timestamp}_${file.name}?${sasToken}`;

                    try {
                        const response = await fetch(blobUrl, {
                            method: "PUT",
                            headers: {
                                "x-ms-blob-type": "BlockBlob",
                            },
                            body: file,
                        });

                        if (!response.ok) {
                            allOk = false;
                            break;
                        }
                    } catch (error) {
                        console.error("Fehler beim Upload:", error);
                        allOk = false;
                        break;
                    }
                }

                stopSpinner();
                if (allOk) {
                    document.getElementById("status").textContent = "Alle Dateien wurden erfolgreich hochgeladen!";
                    update = true;
                    const interval = setInterval(async () => {
                        await getBlops();
                        console.log("update", update);
                        if (!update) {
                            clearInterval(interval);
                        }
                    }, 3000);
                    setTimeout(() => {
                        document.getElementById("status").textContent = "";
                    }, 3000);
                } else {
                    document.getElementById("status").textContent = "Fehler beim Hochladen einer oder mehrerer Dateien.";
                }
            });
        </script>
    </body>
</html>
